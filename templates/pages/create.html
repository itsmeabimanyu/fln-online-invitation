{% extends 'layouts/base.html' %}
{% block content %}
{% load static %}
<div class="row mb-2 mb-xl-3">
    <div class="col-auto d-none d-sm-block">
        <h3><strong>{{ title|title }}</strong> {{ title_action|title }}</h3>
    </div>
    <div class="col-auto ms-auto text-end mt-n1">
        <!-- <a href="#" data-micromodal-trigger="modal-1" class="btn btn-success">New Event</a>
        <a href="{% url 'event_create' %}" class="btn btn-success">New Event</a> -->
        <button class="btn btn-primary" type="button" onclick="window.history.back();">Back</button>
    </div>
</div>

<div class="row">
    <div class="col-xl-12">
        <div class="card mb-4 border">
            <div class="card-header px-4 pt-4">
                <div class="card-actions float-end">
                </div>
                <h3 class="fw-bolder">{{ event }}</h3>
                <div class="badge {% if active_status %}bg-success{% else %}bg-danger{% endif %} my-2">
                    {% if active_status %}Active{% else %}Inactive{% endif %}
                </div>
            </div>
            <form method="post">
                {% csrf_token %}
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="tbl_participant" class="display row-border" style="width:100%">
                            <thead>
                                <tr><th>No</th> <!-- Kolom untuk nomor urut -->
                                    <th>Guest Name</th>
                                    <th>Guest Email (Optional)</th>
                                    <th>Organization (Optional)</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in items %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ item.guest_name }}</td>
                                    <td>{{ item.guest_email }}</td>
                                    <td>{{ item.organization }}</td>
                                    <td>
                                        <!-- Optional: you can add actions like Edit or Delete -->
                                        <a href="#" class="btn btn-warning btn-sm">Update</a>
                                        <button type="button" data-micromodal-trigger="modal-{{ item.id }}" class="btn btn-danger btn-sm">Delete</button>
                                    </td>
                                </tr>
                                {% endfor %}
                                <tr>
                                    <td>{{items|length|add:1}}</td>
                                    <td><input type="text" class="form-control" name="guest_name" required></td>
                                    <td><input type="email" class="form-control" name="guest_email"></td>
                                    <td><input type="text" class="form-control" name="organization"></td>
                                    <td><button class="btn btn-danger btn-sm deleteRow">Delete</button></td> 
                                </tr>
                                <!-- More rows can be added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer">
                    <button type="button" id="addRow" class="btn btn-info">Add New Row</button>
                    <button type="submit" class="btn btn-success">Submit</button>
                </div>
                <script>
                    $(document).ready(function() {
                        var table = $('#tbl_participant').DataTable();
                
                        // Add new row when the "Add Row" button is clicked
                        $('#addRow').on('click', function() {
                            var rowCount = table.rows().count();  // Get current row count
                            
                            // Add a new row with input fields and a delete button
                            table.row.add([
                                rowCount + 1,  // Add row number (new row + 1)
                                '<input type="text" class="form-control" name="guest_name" required>',
                                '<input type="email" class="form-control" name="guest_email">',
                                '<input type="text" class="form-control" name="organization">',
                                '<button class="btn btn-danger btn-sm deleteRow">Delete</button>'
                            ]).draw(false);  // draw(false) prevents table from scrolling to top
                        });
                
                        // Delete row functionality
                        $(document).on('click', '.deleteRow', function() {
                            var row = $(this).closest('tr');  // Find the row that contains the clicked button
                            
                            // Ensure there's more than one row before allowing deletion
                            if (table.rows().count() > 1) {
                                table.row(row).remove().draw();  // Remove the row
                                updateRowNumbers();  // Update row numbers after deletion
                            } else {
                                alert("You cannot delete the last row!");
                            }
                            
                            // Update delete button visibility after deletion
                            toggleDeleteButtonsVisibility();
                        });
                
                        // Function to toggle delete button visibility based on row count
                        function toggleDeleteButtonsVisibility() {
                            var deleteButtons = $('.deleteRow');
                            if (table.rows().count() <= 1) {
                                deleteButtons.hide();  // Hide delete buttons if there's 1 or fewer rows
                            } else {
                                deleteButtons.show();  // Show delete buttons if more than 1 row
                            }
                        }
                
                        // Update row numbers after a row is added or removed
                        function updateRowNumbers() {
                            table.rows().every(function(index) {
                                var row = this.node();
                                $(row).find('td:first').text(index + 1);  // Update row number in the first column
                            });
                        }
                
                        // Initial check on page load to adjust delete button visibility
                        toggleDeleteButtonsVisibility();
                    });
                </script>
                
            </form>
        </div>
    </div>
</div>

{% for item in items %}
<!-- Modal untuk menghapus item -->
<div class="modal micromodal-slide" id="modal-{{ item.id }}" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
        <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="modal-{{ item.id }}-title">
            <!-- Header Modal -->
            <header class="modal__header">
                <h2 class="modal__title" id="modal-{{ item.id }}-title">
                    <strong>{{ title|title }}</strong> Delete
                </h2>
                <button class="modal__close" aria-label="Tutup modal" data-micromodal-close></button>
            </header>

            <!-- Konten Modal -->
            <main class="modal__content" id="modal-{{ item.id }}-content">
                <p>Are you sure you want to delete {{ title }} <strong>{{ item.guest_name }}</strong>?</p>
                <!-- Form untuk menghapus item -->
                <form method="post" action="{% url 'participant_delete' pk=item.pk %}">
                    {% csrf_token %}
                    <div class="modal__footer">
                        <button type="button" class="btn btn-secondary" data-micromodal-close>Cancel</button>
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </div>
                </form>
            </main>
        </div>
    </div>
</div>
{% endfor %}

{% endblock content %}