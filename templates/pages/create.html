{% extends 'layouts/base.html' %}
{% block content %}
{% load static %}
<div class="row mb-2 mb-xl-3">
    <div class="col-auto d-none d-sm-block">
        <h3><strong>{{ title|title }}</strong> {{ title_action|title }}</h3>
    </div>
    <div class="col-auto ms-auto text-end mt-n1">
        <!-- <a href="#" data-micromodal-trigger="modal-1" class="btn btn-success">New Event</a>
        <a href="{% url 'event_create' %}" class="btn btn-success">New Event</a> -->
        <button class="btn btn-primary" type="button" onclick="window.history.back();">Back</button>
    </div>
</div>
<div class="row">
    <div class="col-xl-12">
        <div class="card mb-4 border">
            <div class="card-header px-4 pt-4">
                <div class="card-actions float-end">
                </div>
                <h3 class="fw-bolder">{{ event }}</h3>
                <div class="badge {% if active_status %}bg-success{% else %}bg-danger{% endif %} my-2">
                    {% if active_status %}Active{% else %}Inactive{% endif %}
                </div>
            </div>
            <form method="post">
                {% csrf_token %}
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="tbl_participant" class="display row-border" style="width:100%">
                            <thead>
                                <tr>
                                    <!-- Checkbox Check All di header -->
                                    <th><input type="checkbox" class="form-check-input item-checkbox" id="select-all"></th>
                                    <th>No</th> <!-- Kolom untuk nomor urut -->
                                    <th>Guest Name<span class="text-danger"> *</span></th>
                                    <th>Organization</th>
                                    <th>Email<span class="text-danger"> *</span></th>
                                    <th>Approve?</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in items %}
                                <tr>
                                    <td>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input item-checkbox" name="approve" value="{{ item.id }}">
                                        </div>
                                    </td>
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ item.guest_name }}</td>
                                    <td>{{ item.organization }}</td>
                                    <td>{{ item.email }}</td>
                                    <td>{{ item.is_approved|yesno|capfirst }}</td>
                                    <td>
                                        <div class="dropdown position-relative">
                                            <button class="btn btn-sm btn-info dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                              Option
                                            </button>
                                            <ul class="dropdown-menu">
                                              <li><a class="dropdown-item" href="#">Edit</a></li>
                                              <li><button type="button" data-micromodal-trigger="modal-approve-{{ item.id }}" class="dropdown-item">{{ item.action|capfirst }}</button></li>
                                              <li><button type="button" data-micromodal-trigger="modal-delete-{{ item.id }}" class="dropdown-item text-danger">Delete</button></li>
                                            </ul>
                                          </div>
                                    </td>
                                </tr>
                                {% endfor %}
                                <tr>
                                    <td></td>
                                    <td>{{items|length|add:1}}</td>
                                    <td><input type="text" class="form-control" name="guest_name" required></td>
                                    <td><input type="text" class="form-control" name="organization"></td>
                                    <td><input type="email" class="form-control" name="email" required></td>
                                    <td></td>
                                    <td><button class="btn btn-danger btn-sm deleteRow"><i data-feather="trash-2"></i></button></td> 
                                </tr>
                                <!-- More rows can be added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer">
                    <button type="button" id="addRow" class="btn btn-info">Add New Row</button>
                    <button type="submit" class="btn btn-success">Submit</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% block modal %}
    {% include 'pages/modals/modal.html' %}
{% endblock modal %}

<script>
    $(document).ready(function() {
        var table = $('#tbl_participant').DataTable({
            "columnDefs": [
                {
                    "targets": 0,  // Kolom pertama (checkbox)
                    "orderable": false,  // Menonaktifkan sortir pada kolom pertama
                    "searchable": false  // Menonaktifkan pencarian pada kolom pertama (checkbox)
                },
                {
                    "targets": 1,  // Kolom kedua (nomor urut)
                    "orderable": true,  // Mengaktifkan sortir pada kolom kedua
                    "searchable": false  // Menonaktifkan pencarian pada kolom nomor urut
                }
            ],
            "order": [[1, 'asc']]  // Mengatur agar kolom nomor urut diurutkan secara default (ascending)
        });

        // Menambahkan baris baru saat tombol "Add Row" diklik
        $('#addRow').on('click', function() {
            // Menambahkan baris baru dengan checkbox di kolom pertama, input dan tombol delete
            table.row.add([
                '',  // Checkbox di kolom pertama
                table.rows().count() + 1,  // Nomor urut otomatis berdasarkan jumlah baris
                '<input type="text" class="form-control" name="guest_name" required>',
                '<input type="text" class="form-control" name="organization">',
                '<input type="email" class="form-control" name="email" required>',
                '',
                '<button class="btn btn-danger btn-sm deleteRow"><i data-feather="trash-2"></i></button>'
            ]).draw(false);

            updateRowNumbers();  // Memperbarui nomor urut setelah menambahkan baris

            // Memanggil feather.replace() setelah menambahkan elemen baru
            feather.replace();
        });

        // Menghapus baris saat tombol delete diklik
        $(document).on('click', '.deleteRow', function() {
            var row = $(this).closest('tr');  // Temukan baris yang mengandung tombol yang diklik
            table.row(row).remove().draw();  // Hapus baris
            updateRowNumbers();  // Memperbarui nomor urut setelah penghapusan baris
        });

        // Memperbarui nomor urut di setiap baris
        function updateRowNumbers() {
            table.rows().every(function(index) {
                var row = this.node();
                $(row).find('td').eq(1).text(index + 1);  // Mengupdate nomor urut di kolom kedua (index 1)
            });
        }

        // Mengaktifkan fungsi "Select All" hanya untuk checkbox yang terlihat sesuai pencarian
        $('#select-all').on('click', function() {
            var isChecked = $(this).prop('checked');
            // Memilih semua checkbox yang terlihat sesuai hasil pencarian
            table.rows({ search: 'applied' }).nodes().to$().find('input[type="checkbox"]').each(function() {
                $(this).prop('checked', isChecked);  // Setel checkbox sesuai dengan status "Select All"
            });
        });

        // Memastikan checkbox hanya dipilih pada baris yang sesuai hasil pencarian
        $('#tbl_participant').on('change', 'input[type="checkbox"]', function() {
            // Menangani perubahan checkbox per baris
            var rowData = table.row($(this).closest('tr')).data();
            console.log(rowData);  // Menampilkan data baris terkait, jika dibutuhkan
        });
    });
</script>

{% endblock content %}