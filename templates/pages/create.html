{% extends 'layouts/base.html' %}
{% block content %}
{% load static custom_filters %}
<div class="row mb-2 mb-xl-3">
    <div class="col-auto d-none d-sm-block">
        <h3><strong>{{ title|title }}</strong> {{ title_action|title }}</h3>
    </div>
    <div class="col-auto ms-auto text-end mt-n1">
        <!-- <a href="#" data-micromodal-trigger="modal-1" class="btn btn-success">New Event</a>
        <a href="{% url 'event_create' %}" class="btn btn-success">New Event</a> -->
        <button class="btn btn-primary" type="button" onclick="window.history.back();">Back</button>
    </div>
</div>
<div class="row">
    <div class="col-xl-12">
        <div class="card mb-4 border">
            <div class="card-header px-4 pt-4">
                <div class="card-actions float-end">
                </div>
                <p class="fs-3">{{ subtitle }}</p>
                {{ active_status|safe }}
            </div>
            <form method="post">
                {% csrf_token %}
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="tbl_participant" class="display row-border" style="width:100%">
                            <thead>
                                <tr>
                                    <!-- Checkbox Check All di header -->
                                    <th><input type="checkbox" class="form-check form-check-input item-checkbox" id="select-all"></th>
                                    <th>No</th> <!-- Kolom untuk nomor urut -->
                                    {% for key, value in fields.items %}
                                    <th>{{ value }}</th>
                                    {% endfor %}
                                    <th style="width:10%">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in items %}
                                <tr>
                                    <td><input type="checkbox" class="form-check form-check-input item-checkbox" name="approve" value="{{ item.id }}"></td>
                                    <td>{{ forloop.counter }}</td>
                                    {% for key, value in fields.items %}
                                    <td>{{ item|get_field_value:key|safe }}</td>
                                    {% endfor %}
                                    <td>
                                        <button type="button" class="btn btn-sm btn-primary dropdown-toggle" data-bs-toggle="collapse" data-bs-target="#act-{{ item.id }}">Options </button>
                                        <div id="act-{{ item.id }}" class="collapse mt-1">
                                            {% for value in item.buttons_action %}
                                                {{ value|safe  }}
                                            {% endfor %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                                <tr>
                                    {% for value in first_add_td %}
                                        {{ value|safe }}
                                    {% endfor %}
                                    <td>{{items|length|add:1}}</td>
                                    {% for field in form %}
                                        <td>{{ field }}</td>
                                    {% endfor %}
                                    {% for value in last_add_td %}
                                        {{ value|safe }}
                                    {% endfor %}
                                    <td><button class="btn btn-danger btn-sm deleteRow"><i data-feather="trash-2"></i></button></td> 
                                </tr>
                                <!-- More rows can be added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer">
                    <button type="button" id="addRow" class="btn btn-info">Add New Row</button>
                    <button type="submit" class="btn btn-success">Submit</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% block modal %}
    {% include 'pages/modals/modal.html' %}
{% endblock modal %}

<script>
    $(document).ready(function() {
        var table = $('#tbl_participant').DataTable({
            "columnDefs": [
                {
                    "targets": 0,  // Kolom pertama (checkbox)
                    "orderable": false,  // Menonaktifkan sortir pada kolom pertama
                    "searchable": false  // Menonaktifkan pencarian pada kolom pertama (checkbox)
                },
                {
                    "targets": 1,  // Kolom kedua (nomor urut)
                    "orderable": true,  // Mengaktifkan sortir pada kolom kedua
                    "searchable": false  // Menonaktifkan pencarian pada kolom nomor urut
                }
            ],
            "order": [[1, 'asc']]  // Mengatur agar kolom nomor urut diurutkan secara default (ascending)
        });

        // Menambahkan baris baru saat tombol "Add Row" diklik
        $('#addRow').on('click', function() {
            // Membuat array untuk menyimpan data baris baru
            var newRow = [
                {% for value in first_add_td_js %}
                '{{ value|escapejs }}',  // Checkbox di kolom pertama
                {% endfor %}
                table.rows().count() + 1,  // Nomor urut otomatis berdasarkan jumlah baris
            ];
        
            // Menambahkan field-form ke dalam array
            {% for field in form %}
                newRow.push('{{ field }}');
            {% endfor %}

            // Menambahkan kolom kosong
            {% for td in last_add_td %}
                newRow.push('{{ td|escapejs }}');
            {% endfor %}
        
            // Menambahkan tombol delete
            newRow.push('<button class="btn btn-danger btn-sm deleteRow"><i data-feather="trash-2"></i></button>');
        
            // Menambahkan baris baru ke tabel
            table.row.add(newRow).draw(false);
        
            // Memperbarui nomor urut setelah menambahkan baris
            updateRowNumbers();
        
            // Memanggil feather.replace() setelah menambahkan elemen baru
            feather.replace();
        });
        
        // Menghapus baris saat tombol delete diklik
        $(document).on('click', '.deleteRow', function() {
            var row = $(this).closest('tr');  // Temukan baris yang mengandung tombol yang diklik
            table.row(row).remove().draw();  // Hapus baris
            updateRowNumbers();  // Memperbarui nomor urut setelah penghapusan baris
        });

        // Memperbarui nomor urut di setiap baris
        function updateRowNumbers() {
            table.rows().every(function(index) {
                var row = this.node();
                $(row).find('td').eq(1).text(index + 1);  // Mengupdate nomor urut di kolom kedua (index 1)
            });
        }

        // Mengaktifkan fungsi "Select All" hanya untuk checkbox yang terlihat sesuai pencarian
        $('#select-all').on('click', function() {
            var isChecked = $(this).prop('checked');
            // Memilih semua checkbox yang terlihat sesuai hasil pencarian
            table.rows({ search: 'applied' }).nodes().to$().find('input[type="checkbox"]').each(function() {
                $(this).prop('checked', isChecked);  // Setel checkbox sesuai dengan status "Select All"
            });
        });

        // Memastikan checkbox hanya dipilih pada baris yang sesuai hasil pencarian
        $('#tbl_participant').on('change', 'input[type="checkbox"]', function() {
            // Menangani perubahan checkbox per baris
            var rowData = table.row($(this).closest('tr')).data();
            console.log(rowData);  // Menampilkan data baris terkait, jika dibutuhkan
        });
    });
</script>

{% endblock content %}